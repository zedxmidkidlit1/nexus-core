name: CI Release Gates

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:

jobs:
  quality:
    name: Fmt, Clippy, Tests, Benchmark Smoke
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Npcap SDK (Packet.lib)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zipPath = Join-Path $env:RUNNER_TEMP "npcap-sdk.zip"
          $urls = @(
            "https://npcap.com/dist/npcap-sdk-1.13.zip",
            "https://npcap.com/dist/npcap-sdk.zip"
          )

          $downloaded = $false
          foreach ($url in $urls) {
            try {
              Invoke-WebRequest -Uri $url -OutFile $zipPath
              Write-Host "Downloaded Npcap SDK from $url"
              $downloaded = $true
              break
            } catch {
              Write-Host "Failed to download from $url"
            }
          }
          if (-not $downloaded) {
            throw "Failed to download Npcap SDK from known URLs."
          }

          Expand-Archive -Path $zipPath -DestinationPath "C:\" -Force
          $sdkRoots = Get-ChildItem -Path "C:\" -Directory |
            Where-Object { $_.Name -like "npcap-sdk*" }
          if (-not $sdkRoots) {
            throw "Npcap SDK extraction folder not found under C:\\."
          }

          $packetLib = $null
          foreach ($root in $sdkRoots) {
            $candidate = Get-ChildItem -Path $root.FullName -Recurse -Filter "Packet.lib" -ErrorAction SilentlyContinue |
              Select-Object -First 1
            if ($candidate) {
              $packetLib = $candidate
              break
            }
          }
          if (-not $packetLib) {
            throw "Packet.lib not found after Npcap SDK extraction."
          }

          $libDir = $packetLib.Directory.FullName
          "LIB=$libDir;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "NPCAP_SDK_LIB=$libDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Configured Packet.lib search path: $libDir"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cargo fmt (check)
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Cargo test
        run: cargo test --all-targets --all-features

      - name: Benchmark smoke
        shell: pwsh
        run: ./scripts/benchmark.ps1 -Mode smoke -Iterations 1
