name: CI Release Gates

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:

permissions:
  contents: read

jobs:
  quality-linux:
    name: Fmt, Clippy, Tests, Smoke (Linux)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-dejavu-core

      - name: Cargo fmt (check)
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Cargo test
        run: cargo test --all-targets --all-features

      - name: Release smoke checks
        run: |
          cargo build --release
          ./target/release/nexus-core --version
          ./target/release/nexus-core --help
          ./target/release/nexus-core ai-check

  windows-link-check:
    name: Windows Build/Link Check (Npcap SDK)
    runs-on: windows-2025

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Npcap SDK (Packet.lib)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zipPath = Join-Path $env:RUNNER_TEMP "npcap-sdk.zip"
          $extractRoot = Join-Path $env:RUNNER_TEMP "npcap-sdk-extract"
          $urls = @(
            "https://npcap.com/dist/npcap-sdk-1.13.zip",
            "https://npcap.com/dist/npcap-sdk.zip"
          )

          $downloaded = $false
          foreach ($url in $urls) {
            try {
              Invoke-WebRequest -Uri $url -OutFile $zipPath
              Write-Host "Downloaded Npcap SDK from $url"
              $downloaded = $true
              break
            } catch {
              Write-Host "Failed to download from $url"
            }
          }
          if (-not $downloaded) {
            throw "Failed to download Npcap SDK from known URLs."
          }

          if (Test-Path $extractRoot) {
            Remove-Item -Path $extractRoot -Recurse -Force
          }
          New-Item -Path $extractRoot -ItemType Directory | Out-Null
          Expand-Archive -Path $zipPath -DestinationPath $extractRoot -Force

          $packetLib = $null
          $candidate = Get-ChildItem -Path $extractRoot -Recurse -Filter "Packet.lib" -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -match "\\Lib\\x64\\Packet\.lib$" } |
            Select-Object -First 1
          if ($candidate) {
            $packetLib = $candidate
          }

          if (-not $packetLib) {
            $knownPacketLibPaths = @(
              "C:\\npcap-sdk\\Lib\\x64\\Packet.lib",
              "C:\\Program Files\\Npcap\\SDK\\Lib\\x64\\Packet.lib"
            )
            foreach ($knownPath in $knownPacketLibPaths) {
              if (Test-Path $knownPath) {
                $packetLib = Get-Item $knownPath
                break
              }
            }
          }

          if (-not $packetLib) {
            throw "Packet.lib not found after Npcap SDK extraction. Checked: $extractRoot"
          }

          $libDir = $packetLib.Directory.FullName
          "LIB=$libDir;$env:LIB" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "NPCAP_SDK_LIB=$libDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Configured Packet.lib search path: $libDir"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo check
        run: cargo check --all-targets --all-features

      - name: Cargo test (build only)
        run: cargo test --all-targets --all-features --no-run
